---
import LandingLayout from '../layouts/LandingLayout.astro';

const title = 'Start Free Trial - AgencyOS';
const description = 'Enter your email to start your 7-day free trial of AgencyOS.';
---

<LandingLayout title={title} description={description}>
  <section class="signup-hero">
    <h1>üöÄ Start Your Free Trial</h1>
    <p>Enter your email to get started. No credit card required.</p>
  </section>

  <section class="signup-section">
    <div class="signup-card">
      
      <div class="plan-selected" id="plan-badge">
        <span class="plan-icon">‚≠ê</span>
        <span class="plan-name">Pro Plan</span>
        <span class="plan-price" id="plan-price">$99/month</span>
      </div>

      <form id="signup-form" class="signup-form">
        
        <div class="form-group">
          <label for="email">Email Address *</label>
          <input 
            type="email" 
            id="email" 
            name="email" 
            placeholder="your@email.com"
            required
          />
        </div>

        <div class="form-group">
          <label for="name">Full Name *</label>
          <input 
            type="text" 
            id="name" 
            name="name" 
            placeholder="John Doe"
            required
          />
        </div>

        <div class="form-group">
          <label for="promo">Promo Code (Optional)</label>
          <div class="promo-input-group">
            <input 
              type="text" 
              id="promo" 
              name="promo" 
              placeholder="AGENCYOS-XXXX-XXXX"
            />
            <button type="button" id="apply-promo" class="btn-apply">Apply</button>
          </div>
          <div id="promo-status" class="promo-status"></div>
        </div>

        <div class="price-summary" id="price-summary">
          <div class="summary-row">
            <span>Pro Plan (Monthly)</span>
            <span id="original-price">$99.00</span>
          </div>
          <div class="summary-row discount hidden" id="discount-row">
            <span>Discount</span>
            <span id="discount-amount" class="text-green">-$0.00</span>
          </div>
          <div class="summary-row total">
            <span>Total</span>
            <span id="total-price">$99.00</span>
          </div>
        </div>

        <button type="submit" class="btn-primary" id="submit-btn">
          Start 7-Day Free Trial ‚Üí
        </button>

        <p class="terms-text">
          By signing up, you agree to our 
          <a href="/terms">Terms of Service</a> and 
          <a href="/privacy">Privacy Policy</a>.
        </p>

      </form>

      <div class="benefits-list">
        <h4>What you get:</h4>
        <ul>
          <li>‚úÖ 85+ AI commands</li>
          <li>‚úÖ 7-day free trial</li>
          <li>‚úÖ Cancel anytime</li>
          <li>‚úÖ 30-day money-back guarantee</li>
        </ul>
      </div>

    </div>
  </section>
</LandingLayout>

<style>
  .signup-hero {
    text-align: center;
    padding: 64px 24px 32px;
  }

  .signup-hero h1 {
    font-size: 2.5rem;
    font-weight: 800;
    background: linear-gradient(135deg, #22c55e, #06b6d4);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 16px;
  }

  .signup-hero p {
    color: var(--color-text-muted);
    font-size: 1.1rem;
  }

  .signup-section {
    max-width: 500px;
    margin: 0 auto;
    padding: 24px;
  }

  .signup-card {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 16px;
    padding: 32px;
  }

  .plan-selected {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: var(--color-bg-tertiary);
    border-radius: 12px;
    margin-bottom: 24px;
  }

  .plan-icon {
    font-size: 1.5rem;
  }

  .plan-name {
    font-weight: 600;
    color: var(--color-text-primary);
  }

  .plan-price {
    margin-left: auto;
    color: #22c55e;
    font-weight: 700;
  }

  .signup-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .form-group label {
    font-weight: 600;
    color: var(--color-text-primary);
    font-size: 0.9rem;
  }

  .form-group input {
    padding: 14px 16px;
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    color: var(--color-text-primary);
    font-size: 1rem;
  }

  .form-group input:focus {
    outline: none;
    border-color: #22c55e;
  }

  .form-group input::placeholder {
    color: var(--color-text-muted);
  }

  .promo-input-group {
    display: flex;
    gap: 8px;
  }

  .promo-input-group input {
    flex: 1;
  }

  .btn-apply {
    padding: 14px 20px;
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    color: var(--color-text-primary);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-apply:hover {
    background: var(--color-bg-secondary);
    border-color: #22c55e;
  }

  .promo-status {
    font-size: 0.85rem;
    min-height: 20px;
  }

  .promo-status.success {
    color: #22c55e;
  }

  .promo-status.error {
    color: #ef4444;
  }

  .price-summary {
    background: var(--color-bg-tertiary);
    border-radius: 12px;
    padding: 16px;
  }

  .summary-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    color: var(--color-text-secondary);
    font-size: 0.9rem;
  }

  .summary-row.total {
    border-top: 1px solid var(--color-border);
    margin-top: 8px;
    padding-top: 16px;
    font-weight: 700;
    color: var(--color-text-primary);
    font-size: 1rem;
  }

  .text-green {
    color: #22c55e;
  }

  .hidden {
    display: none;
  }

  .btn-primary {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(34, 197, 94, 0.3);
  }

  .btn-primary.free {
    background: linear-gradient(135deg, #eab308, #f97316);
  }

  .terms-text {
    text-align: center;
    font-size: 0.75rem;
    color: var(--color-text-muted);
    margin: 0;
  }

  .terms-text a {
    color: #22c55e;
    text-decoration: none;
  }

  .terms-text a:hover {
    text-decoration: underline;
  }

  .benefits-list {
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid var(--color-border);
  }

  .benefits-list h4 {
    font-size: 0.9rem;
    color: var(--color-text-muted);
    margin: 0 0 12px 0;
  }

  .benefits-list ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }

  .benefits-list li {
    font-size: 0.85rem;
    color: var(--color-text-secondary);
  }

  @media (max-width: 480px) {
    .signup-hero h1 {
      font-size: 2rem;
    }

    .signup-card {
      padding: 20px;
    }

    .benefits-list ul {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  const form = document.getElementById('signup-form') as HTMLFormElement;
  const promoInput = document.getElementById('promo') as HTMLInputElement;
  const applyPromoBtn = document.getElementById('apply-promo');
  const promoStatus = document.getElementById('promo-status');
  const discountRow = document.getElementById('discount-row');
  const discountAmount = document.getElementById('discount-amount');
  const totalPrice = document.getElementById('total-price');
  const originalPriceEl = document.getElementById('original-price');
  const planPrice = document.getElementById('plan-price');
  const submitBtn = document.getElementById('submit-btn');

  const ORIGINAL_PRICE = 99;
  let currentDiscount = 0;
  let validPromoCode = '';

  // Check URL params for plan
  const urlParams = new URLSearchParams(window.location.search);
  const plan = urlParams.get('plan') || 'pro';
  const promoFromUrl = urlParams.get('promo');

  // Pre-fill promo from URL
  if (promoFromUrl && promoInput) {
    promoInput.value = promoFromUrl;
  }

  // Apply promo code
  applyPromoBtn?.addEventListener('click', () => {
    const code = promoInput?.value.trim().toUpperCase();
    
    if (!code) {
      showPromoStatus('Please enter a promo code', 'error');
      return;
    }

    // Validate code pattern
    const validPattern = /^AGENCYOS-[A-Z0-9]{4}-[A-Z0-9]{4}$/;
    
    // Check localStorage first
    const storedCampaign = localStorage.getItem('agencyos_promo_codes');
    let isValid = false;
    let discount = 0;

    if (storedCampaign) {
      const campaign = JSON.parse(storedCampaign);
      if (campaign.codes && campaign.codes.includes(code)) {
        discount = campaign.discount;
        isValid = true;
      }
    }

    // Check pattern (all valid pattern codes = 100% off for first 100)
    if (!isValid && validPattern.test(code)) {
      discount = 100;
      isValid = true;
    }

    if (isValid) {
      currentDiscount = discount;
      validPromoCode = code;
      updatePricing(discount);
      showPromoStatus(`‚úÖ ${discount}% discount applied!`, 'success');
      
      // Save to localStorage
      localStorage.setItem('agencyos_applied_code', JSON.stringify({ code, discount }));
    } else {
      showPromoStatus('‚ùå Invalid promo code', 'error');
    }
  });

  function showPromoStatus(message: string, type: 'success' | 'error') {
    if (promoStatus) {
      promoStatus.textContent = message;
      promoStatus.className = 'promo-status ' + type;
    }
  }

  function updatePricing(discount: number) {
    const discountValue = (ORIGINAL_PRICE * discount / 100);
    const finalPrice = ORIGINAL_PRICE - discountValue;

    if (discount > 0) {
      discountRow?.classList.remove('hidden');
      if (discountAmount) discountAmount.textContent = `-$${discountValue.toFixed(2)}`;
    }

    if (totalPrice) {
      if (finalPrice === 0) {
        totalPrice.textContent = 'FREE';
        totalPrice.classList.add('text-green');
      } else {
        totalPrice.textContent = `$${finalPrice.toFixed(2)}`;
      }
    }

    if (planPrice) {
      if (finalPrice === 0) {
        planPrice.textContent = 'FREE!';
      } else {
        planPrice.textContent = `$${finalPrice}/month`;
      }
    }

    // Update button text
    if (submitBtn) {
      if (finalPrice === 0) {
        submitBtn.textContent = 'üéâ Get FREE Access ‚Üí';
        submitBtn.classList.add('free');
      }
    }
  }

  // Form submission
  form?.addEventListener('submit', (e) => {
    e.preventDefault();

    const email = (document.getElementById('email') as HTMLInputElement)?.value;
    const name = (document.getElementById('name') as HTMLInputElement)?.value;

    // Store user data
    const userData = {
      email,
      name,
      promoCode: validPromoCode,
      discount: currentDiscount,
      plan: plan,
      timestamp: new Date().toISOString()
    };

    localStorage.setItem('agencyos_user', JSON.stringify(userData));

    // Determine destination
    if (currentDiscount === 100) {
      // 100% off = go directly to success
      window.location.href = '/success?free=true';
    } else {
      // Go to checkout (Polar.sh or checkout page)
      // For now, redirect to checkout page
      window.location.href = `/checkout?plan=${plan}&email=${encodeURIComponent(email)}&name=${encodeURIComponent(name)}${validPromoCode ? '&promo=' + validPromoCode : ''}`;
    }
  });

  // Check for existing promo code in localStorage
  const existingCode = localStorage.getItem('agencyos_applied_code');
  if (existingCode && promoInput) {
    const { code, discount } = JSON.parse(existingCode);
    promoInput.value = code;
    currentDiscount = discount;
    validPromoCode = code;
    updatePricing(discount);
    showPromoStatus(`‚úÖ ${discount}% discount applied!`, 'success');
  }
</script>

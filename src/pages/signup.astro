---
import LandingLayout from '../layouts/LandingLayout.astro';

const title = 'Start Free Trial - AgencyOS';
const description = 'Enter your email to start your 7-day free trial of AgencyOS.';
---

<LandingLayout title={title} description={description}>
  <section class="signup-hero">
    <h1>üöÄ Start Your Free Trial</h1>
    <p>Enter your email to get started. No credit card required.</p>
  </section>

  <section class="signup-section">
    <div class="signup-card">
      
      <div class="plan-selected" id="plan-badge">
        <span class="plan-icon">‚≠ê</span>
        <span class="plan-name">Pro Plan</span>
        <span class="plan-price" id="plan-price">$99/month</span>
      </div>

      <form id="signup-form" class="signup-form">
        
        <div class="form-group">
          <label for="email">Email Address *</label>
          <input 
            type="email" 
            id="email" 
            name="email" 
            placeholder="your@email.com"
            required
          />
        </div>

        <div class="form-group">
          <label for="name">Full Name *</label>
          <input 
            type="text" 
            id="name" 
            name="name" 
            placeholder="John Doe"
            required
          />
        </div>

        <div class="form-group">
          <label for="promo">Promo Code (Optional)</label>
          <div class="promo-input-group">
            <input 
              type="text" 
              id="promo" 
              name="promo" 
              placeholder="AGENCYOS-XXXX-XXXX"
            />
            <button type="button" id="apply-promo" class="btn-apply">Apply</button>
          </div>
          <div id="promo-status" class="promo-status"></div>
        </div>

        <div class="price-summary" id="price-summary">
          <div class="summary-row">
            <span>Pro Plan (Monthly)</span>
            <span id="original-price">$99.00</span>
          </div>
          <div class="summary-row discount hidden" id="discount-row">
            <span>Discount</span>
            <span id="discount-amount" class="text-green">-$0.00</span>
          </div>
          <div class="summary-row total">
            <span>Total</span>
            <span id="total-price">$99.00</span>
          </div>
        </div>

        <button type="submit" class="btn-primary" id="submit-btn">
          Start 7-Day Free Trial ‚Üí
        </button>

        <p class="terms-text">
          By signing up, you agree to our 
          <a href="/terms">Terms of Service</a> and 
          <a href="/privacy">Privacy Policy</a>.
        </p>

      </form>

      <div class="benefits-list">
        <h4>What you get:</h4>
        <ul>
          <li>‚úÖ 125+ AI commands</li>
          <li>‚úÖ 7-day free trial</li>
          <li>‚úÖ Cancel anytime</li>
          <li>‚úÖ 30-day money-back guarantee</li>
        </ul>
      </div>

    </div>
    
    <!-- Confetti Canvas -->
    <canvas id="confetti-canvas"></canvas>
  </section>
</LandingLayout>

<style>
  /* ===================== WOW SIGNUP ANIMATIONS ===================== */
  /* Entrance animation for hero */
  .signup-hero {
    text-align: center;
    padding: 64px 24px 32px;
    animation: hero-fade-in 0.6s ease-out;
  }

  @keyframes hero-fade-in {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .signup-hero h1 {
    font-size: 2.5rem;
    font-weight: 800;
    background: linear-gradient(135deg, #22c55e, #06b6d4, #22c55e);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 16px;
    animation: text-shine 4s linear infinite;
  }

  @keyframes text-shine {
    0% { background-position: 0% center; }
    100% { background-position: 200% center; }
  }

  .signup-hero p {
    color: var(--color-text-muted);
    font-size: 1.1rem;
    animation: hero-fade-in 0.8s ease-out 0.2s both;
  }

  .signup-section {
    max-width: 500px;
    margin: 0 auto;
    padding: 24px;
  }

  /* Card entrance with glow */
  .signup-card {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 16px;
    padding: 32px;
    position: relative;
    overflow: hidden;
    animation: card-entrance 0.7s ease-out 0.3s both;
  }

  @keyframes card-entrance {
    from { opacity: 0; transform: translateY(40px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }

  /* Floating particles inside card */
  .signup-card::before {
    content: '';
    position: absolute;
    top: 20%;
    left: 10%;
    width: 6px;
    height: 6px;
    background: #22c55e;
    border-radius: 50%;
    opacity: 0.3;
    animation: float-particle 6s ease-in-out infinite;
    pointer-events: none;
  }

  .signup-card::after {
    content: '';
    position: absolute;
    bottom: 30%;
    right: 15%;
    width: 4px;
    height: 4px;
    background: #06b6d4;
    border-radius: 50%;
    opacity: 0.3;
    animation: float-particle 8s ease-in-out infinite 2s;
    pointer-events: none;
  }

  @keyframes float-particle {
    0%, 100% { transform: translateY(0) scale(1); opacity: 0.3; }
    50% { transform: translateY(-15px) scale(1.2); opacity: 0.5; }
  }

  .plan-selected {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: var(--color-bg-tertiary);
    border-radius: 12px;
    margin-bottom: 24px;
    position: relative;
    z-index: 1;
    animation: slide-in 0.5s ease-out 0.5s both;
  }

  @keyframes slide-in {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
  }

  .plan-icon {
    font-size: 1.5rem;
    animation: star-pulse 2s ease-in-out infinite;
  }

  @keyframes star-pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
  }

  .plan-name {
    font-weight: 600;
    color: var(--color-text-primary);
  }

  .plan-price {
    margin-left: auto;
    color: #22c55e;
    font-weight: 700;
  }

  .signup-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
    position: relative;
    z-index: 1;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    animation: fade-up 0.5s ease-out both;
  }

  .form-group:nth-child(1) { animation-delay: 0.6s; }
  .form-group:nth-child(2) { animation-delay: 0.7s; }
  .form-group:nth-child(3) { animation-delay: 0.8s; }

  @keyframes fade-up {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .form-group label {
    font-weight: 600;
    color: var(--color-text-primary);
    font-size: 0.9rem;
  }

  /* Input focus glow effect */
  .form-group input {
    padding: 14px 16px;
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    color: var(--color-text-primary);
    font-size: 1rem;
    transition: all 0.3s ease;
  }

  .form-group input:focus {
    outline: none;
    border-color: #22c55e;
    box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.15), 0 0 20px rgba(34, 197, 94, 0.1);
    transform: scale(1.01);
  }

  .form-group input::placeholder {
    color: var(--color-text-muted);
  }

  .promo-input-group {
    display: flex;
    gap: 8px;
  }

  .promo-input-group input {
    flex: 1;
  }

  .btn-apply {
    padding: 14px 20px;
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    color: var(--color-text-primary);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-apply:hover {
    background: var(--color-bg-secondary);
    border-color: #22c55e;
    transform: translateY(-1px);
  }

  .promo-status {
    font-size: 0.85rem;
    min-height: 20px;
    transition: all 0.3s ease;
  }

  .promo-status.success {
    color: #22c55e;
    animation: status-pop 0.3s ease-out;
  }

  .promo-status.error {
    color: #ef4444;
    animation: shake 0.4s ease-out;
  }

  @keyframes status-pop {
    0% { transform: scale(0.8); opacity: 0; }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); opacity: 1; }
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }

  .price-summary {
    background: var(--color-bg-tertiary);
    border-radius: 12px;
    padding: 16px;
    position: relative;
    z-index: 1;
    animation: fade-up 0.5s ease-out 0.9s both;
  }

  .summary-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    color: var(--color-text-secondary);
    font-size: 0.9rem;
  }

  .summary-row.total {
    border-top: 1px solid var(--color-border);
    margin-top: 8px;
    padding-top: 16px;
    font-weight: 700;
    color: var(--color-text-primary);
    font-size: 1rem;
  }

  .text-green {
    color: #22c55e;
  }

  .hidden {
    display: none;
  }

  /* Primary button with pulse */
  .btn-primary {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    z-index: 1;
    animation: fade-up 0.5s ease-out 1s both, btn-glow 3s ease-in-out infinite 1.5s;
  }

  @keyframes btn-glow {
    0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
    50% { box-shadow: 0 0 20px 4px rgba(34, 197, 94, 0.3); }
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(34, 197, 94, 0.4);
  }

  .btn-primary:active {
    transform: scale(0.98);
  }

  .btn-primary.free {
    background: linear-gradient(135deg, #eab308, #f97316);
    animation: fade-up 0.5s ease-out 1s both, free-pulse 2s ease-in-out infinite;
  }

  @keyframes free-pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.5); transform: scale(1); }
    50% { box-shadow: 0 0 25px 8px rgba(234, 179, 8, 0); transform: scale(1.02); }
  }

  .terms-text {
    text-align: center;
    font-size: 0.75rem;
    color: var(--color-text-muted);
    margin: 0;
    animation: fade-up 0.5s ease-out 1.1s both;
  }

  .terms-text a {
    color: #22c55e;
    text-decoration: none;
  }

  .terms-text a:hover {
    text-decoration: underline;
  }

  .benefits-list {
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid var(--color-border);
    position: relative;
    z-index: 1;
    animation: fade-up 0.5s ease-out 1.2s both;
  }

  .benefits-list h4 {
    font-size: 0.9rem;
    color: var(--color-text-muted);
    margin: 0 0 12px 0;
  }

  .benefits-list ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }

  .benefits-list li {
    font-size: 0.85rem;
    color: var(--color-text-secondary);
    transition: color 0.2s ease;
  }

  .benefits-list li:hover {
    color: var(--color-text-primary);
  }

  /* Confetti canvas */
  #confetti-canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1000;
  }

  @media (max-width: 480px) {
    .signup-hero h1 {
      font-size: 2rem;
    }

    .signup-card {
      padding: 20px;
    }

    .benefits-list ul {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  const form = document.getElementById('signup-form') as HTMLFormElement;
  const promoInput = document.getElementById('promo') as HTMLInputElement;
  const applyPromoBtn = document.getElementById('apply-promo');
  const promoStatus = document.getElementById('promo-status');
  const discountRow = document.getElementById('discount-row');
  const discountAmount = document.getElementById('discount-amount');
  const totalPrice = document.getElementById('total-price');
  const originalPriceEl = document.getElementById('original-price');
  const planPrice = document.getElementById('plan-price');
  const submitBtn = document.getElementById('submit-btn');

  const ORIGINAL_PRICE = 99;
  let currentDiscount = 0;
  let validPromoCode = '';
  let validDiscountId: string | null = null; // Polar discount ID
  let discountSource = ''; // 'polar', 'fallback', 'pattern'

  // Check URL params for plan
  const urlParams = new URLSearchParams(window.location.search);
  const plan = urlParams.get('plan') || 'pro';
  const promoFromUrl = urlParams.get('promo');

  // Pre-fill promo from URL
  if (promoFromUrl && promoInput) {
    promoInput.value = promoFromUrl;
  }

  // Apply promo code via API
  applyPromoBtn?.addEventListener('click', async () => {
    const code = promoInput?.value.trim().toUpperCase();
    
    if (!code) {
      showPromoStatus('Please enter a promo code', 'error');
      return;
    }

    // Show loading state
    if (applyPromoBtn) {
      (applyPromoBtn as HTMLButtonElement).disabled = true;
      (applyPromoBtn as HTMLButtonElement).textContent = '...';
    }

    try {
      // Validate via API (checks Polar.sh discounts first)
      const response = await fetch('/api/promo/validate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code })
      });

      const result = await response.json();

      if (result.valid) {
        currentDiscount = result.value;
        validPromoCode = result.code;
        validDiscountId = result.discountId; // Store for checkout
        discountSource = result.source;
        
        updatePricing(result.value);
        showPromoStatus(`‚úÖ ${result.name}: ${result.value}% off!`, 'success');
        
        // Save to localStorage for persistence
        localStorage.setItem('agencyos_applied_code', JSON.stringify({
          code: result.code,
          discount: result.value,
          discountId: result.discountId,
          source: result.source
        }));
      } else {
        showPromoStatus(`‚ùå ${result.error || 'Invalid promo code'}`, 'error');
      }
    } catch (error) {
      console.error('Promo validation error:', error);
      showPromoStatus('‚ùå Failed to validate code', 'error');
    } finally {
      // Reset button
      if (applyPromoBtn) {
        (applyPromoBtn as HTMLButtonElement).disabled = false;
        (applyPromoBtn as HTMLButtonElement).textContent = 'Apply';
      }
    }
  });

  function showPromoStatus(message: string, type: 'success' | 'error') {
    if (promoStatus) {
      promoStatus.textContent = message;
      promoStatus.className = 'promo-status ' + type;
    }
  }

  function updatePricing(discount: number) {
    const discountValue = (ORIGINAL_PRICE * discount / 100);
    const finalPrice = ORIGINAL_PRICE - discountValue;

    if (discount > 0) {
      discountRow?.classList.remove('hidden');
      if (discountAmount) discountAmount.textContent = `-$${discountValue.toFixed(2)}`;
    }

    if (totalPrice) {
      if (finalPrice === 0) {
        totalPrice.textContent = 'FREE';
        totalPrice.classList.add('text-green');
      } else {
        totalPrice.textContent = `$${finalPrice.toFixed(2)}`;
      }
    }

    if (planPrice) {
      if (finalPrice === 0) {
        planPrice.textContent = 'FREE!';
      } else {
        planPrice.textContent = `$${finalPrice}/month`;
      }
    }

    // Update button text
    if (submitBtn) {
      if (finalPrice === 0) {
        submitBtn.textContent = 'üéâ Get FREE Access ‚Üí';
        submitBtn.classList.add('free');
      }
    }
  }

  // Confetti animation
  function triggerConfetti() {
    const canvas = document.getElementById('confetti-canvas') as HTMLCanvasElement;
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    if (!ctx) return;
    
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    const colors = ['#22c55e', '#06b6d4', '#eab308', '#f97316', '#ec4899', '#8b5cf6'];
    const confetti: Array<{
      x: number; y: number; size: number; color: string;
      vx: number; vy: number; rotation: number; rotationSpeed: number;
    }> = [];
    
    // Create confetti pieces
    for (let i = 0; i < 150; i++) {
      confetti.push({
        x: canvas.width / 2,
        y: canvas.height / 2,
        size: Math.random() * 8 + 4,
        color: colors[Math.floor(Math.random() * colors.length)],
        vx: (Math.random() - 0.5) * 20,
        vy: Math.random() * -15 - 5,
        rotation: Math.random() * 360,
        rotationSpeed: (Math.random() - 0.5) * 10
      });
    }
    
    let frame = 0;
    const maxFrames = 120;
    
    function animate() {
      if (frame > maxFrames) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return;
      }
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      confetti.forEach(piece => {
        piece.x += piece.vx;
        piece.y += piece.vy;
        piece.vy += 0.3; // gravity
        piece.rotation += piece.rotationSpeed;
        
        ctx.save();
        ctx.translate(piece.x, piece.y);
        ctx.rotate(piece.rotation * Math.PI / 180);
        ctx.fillStyle = piece.color;
        ctx.globalAlpha = 1 - (frame / maxFrames);
        ctx.fillRect(-piece.size / 2, -piece.size / 2, piece.size, piece.size / 2);
        ctx.restore();
      });
      
      frame++;
      requestAnimationFrame(animate);
    }
    
    animate();
  }

  // Form submission
  form?.addEventListener('submit', (e) => {
    e.preventDefault();

    const email = (document.getElementById('email') as HTMLInputElement)?.value;
    const name = (document.getElementById('name') as HTMLInputElement)?.value;

    // Store user data
    const userData = {
      email,
      name,
      promoCode: validPromoCode,
      discountId: validDiscountId,
      discount: currentDiscount,
      discountSource,
      plan: plan,
      timestamp: new Date().toISOString()
    };

    localStorage.setItem('agencyos_user', JSON.stringify(userData));

    // Trigger confetti celebration!
    triggerConfetti();

    // Update button to show success
    if (submitBtn) {
      submitBtn.textContent = 'üéâ Success!';
      (submitBtn as HTMLButtonElement).disabled = true;
    }

    // Delay redirect to show confetti
    setTimeout(() => {
      // Determine destination
      if (currentDiscount === 100 && discountSource !== 'polar') {
        // 100% off from fallback/pattern = go directly to success (no Polar checkout needed)
        window.location.href = '/success?free=true';
      } else {
        // Go to checkout with discountId for Polar to apply
        const params = new URLSearchParams({
          plan,
          email,
          name,
        });
        if (validPromoCode) params.set('promo', validPromoCode);
        if (validDiscountId) params.set('discountId', validDiscountId);
        
        window.location.href = `/checkout?${params.toString()}`;
      }
    }, 1500); // 1.5s delay to show confetti
  });

  // Check for existing promo code in localStorage
  const existingCode = localStorage.getItem('agencyos_applied_code');
  if (existingCode && promoInput) {
    const { code, discount } = JSON.parse(existingCode);
    promoInput.value = code;
    currentDiscount = discount;
    validPromoCode = code;
    updatePricing(discount);
    showPromoStatus(`‚úÖ ${discount}% discount applied!`, 'success');
  }
</script>

---
import LandingLayout from '../layouts/LandingLayout.astro';

const title = 'Checkout - AgencyOS';
const description = 'Complete your AgencyOS subscription.';
---

<LandingLayout title={title} description={description}>
  <section class="checkout-section">
    <div class="checkout-card">
      
      <div class="loading-state" id="loading-state">
        <div class="spinner"></div>
        <h2>Preparing Checkout...</h2>
        <p>Redirecting to secure payment...</p>
      </div>

      <div class="error-state hidden" id="error-state">
        <span class="error-icon">⚠️</span>
        <h2>Something went wrong</h2>
        <p id="error-message">Unable to process checkout.</p>
        <a href="/signup" class="btn-primary">← Go Back</a>
      </div>

    </div>
  </section>
</LandingLayout>

<style>
  .checkout-section {
    min-height: 60vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
  }

  .checkout-card {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 16px;
    padding: 48px;
    text-align: center;
    max-width: 400px;
    width: 100%;
  }

  .loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
  }

  .spinner {
    width: 48px;
    height: 48px;
    border: 4px solid var(--color-bg-tertiary);
    border-top-color: #22c55e;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .loading-state h2 {
    font-size: 1.5rem;
    color: var(--color-text-primary);
    margin: 0;
  }

  .loading-state p {
    color: var(--color-text-muted);
    margin: 0;
  }

  .error-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
  }

  .error-icon {
    font-size: 3rem;
  }

  .error-state h2 {
    font-size: 1.5rem;
    color: var(--color-text-primary);
    margin: 0;
  }

  .error-state p {
    color: var(--color-text-muted);
    margin: 0;
  }

  .hidden {
    display: none !important;
  }

  .btn-primary {
    display: inline-block;
    padding: 14px 28px;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    margin-top: 8px;
  }
</style>

<script>
  // Polar.sh checkout URL (update with actual product URL)
  const POLAR_CHECKOUT_URL = 'https://polar.sh/agencyos/checkout';

  const loadingState = document.getElementById('loading-state');
  const errorState = document.getElementById('error-state');
  const errorMessage = document.getElementById('error-message');

  // Get params
  const urlParams = new URLSearchParams(window.location.search);
  const plan = urlParams.get('plan') || 'pro';
  const email = urlParams.get('email');
  const name = urlParams.get('name');
  const promo = urlParams.get('promo');

  // Also check localStorage
  const userData = localStorage.getItem('agencyos_user');

  function showError(message: string) {
    if (loadingState) loadingState.classList.add('hidden');
    if (errorState) errorState.classList.remove('hidden');
    if (errorMessage) errorMessage.textContent = message;
  }

  function redirectToCheckout() {
    // Build Polar.sh URL with prefilled data
    let checkoutUrl = POLAR_CHECKOUT_URL;
    
    // Add plan-specific product
    const productIds: Record<string, string> = {
      starter: 'prod_starter',  // Replace with actual Polar.sh product IDs
      pro: 'prod_pro',
      franchise: 'prod_franchise'
    };

    const params = new URLSearchParams();
    
    if (email) params.set('email', email);
    if (promo) params.set('discount_code', promo);
    params.set('success_url', window.location.origin + '/success');
    params.set('cancel_url', window.location.origin + '/signup');

    checkoutUrl += '?' + params.toString();

    // Simulate redirect (in production, this goes to Polar.sh)
    // For demo, we'll just redirect to success after 2s
    setTimeout(() => {
      // In production: window.location.href = checkoutUrl;
      // For demo:
      if (!email) {
        showError('Email is required. Please go back and try again.');
        return;
      }
      
      // Demo mode - simulate successful checkout
      console.log('Would redirect to:', checkoutUrl);
      window.location.href = '/success?plan=' + plan + '&email=' + encodeURIComponent(email || '');
    }, 2000);
  }

  // Check if we have required data
  if (!email && !userData) {
    showError('Missing registration data. Please start from the signup page.');
  } else {
    redirectToCheckout();
  }
</script>

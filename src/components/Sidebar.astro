---
import SidebarNav from './SidebarNav.astro';

interface Props {
  currentPath: string;
}

const { currentPath } = Astro.props;
---

<aside class="sidebar" data-pagefind-ignore>
  <div class="sidebar-header">
    <a href="/" class="logo">
      <span class="logo-icon">üèØ</span>
      <span class="logo-text">AgencyOS</span>
    </a>
    
    <button class="icon-button theme-toggle" onclick="window.toggleTheme()" aria-label="Toggle theme" title="Toggle theme">
      <svg
        width="16"
        height="16"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="sun-icon"
      >
        <circle cx="12" cy="12" r="4"></circle>
        <path d="M12 2v2"></path>
        <path d="M12 20v2"></path>
        <path d="m4.93 4.93 1.41 1.41"></path>
        <path d="m17.66 17.66 1.41 1.41"></path>
        <path d="M2 12h2"></path>
        <path d="M20 12h2"></path>
        <path d="m6.34 17.66-1.41 1.41"></path>
        <path d="m19.07 4.93-1.41 1.41"></path>
      </svg>
      <svg
        width="16"
        height="16"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="moon-icon"
      >
        <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
      </svg>
    </button>
  </div>

  <div class="sidebar-content">
    <!-- Search Trigger (opens modal) -->
    <button class="sidebar-search-trigger" onclick="window.openSearch()" type="button">
      <svg
        width="16"
        height="16"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        class="search-icon"
      >
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.3-4.3"></path>
      </svg>
      <span class="search-placeholder">Search...</span>
      <kbd class="search-kbd">‚åòK</kbd>
    </button>

    <SidebarNav currentPath={currentPath} />

    <!-- Sidebar Footer -->
    <div class="sidebar-footer">
      <a href="/llms-full.txt" target="_blank" rel="noopener noreferrer" class="llms-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        <span>Complete Docs (1.3MB)</span>
      </a>
    </div>
  </div>
</aside>

<script>
  // Save and restore sidebar scroll position
  function initSidebarScroll() {
    const sidebar = document.querySelector('.sidebar-content');
    if (!sidebar) return;

    // Restore scroll position
    const savedPosition = localStorage.getItem('sidebar-scroll-position');
    if (savedPosition) {
      sidebar.scrollTop = parseInt(savedPosition, 10);
    }

    // Save scroll position on scroll (debounced)
    let timeout: number;
    sidebar.addEventListener('scroll', () => {
      clearTimeout(timeout);
      timeout = window.setTimeout(() => {
        localStorage.setItem('sidebar-scroll-position', String(sidebar.scrollTop));
      }, 100);
    });
  }

  // Initialize on page load and after View Transitions
  document.addEventListener('astro:page-load', initSidebarScroll);
  document.addEventListener('DOMContentLoaded', initSidebarScroll);
</script>

<style>
  /* Sidebar (Polar v1.1) */
  .sidebar {
    width: var(--layout-sidebar-width);
    height: 100vh;
    background: var(--color-bg-secondary);
    border-inline-end: 1px solid var(--color-border);
    display: flex;
    flex-direction: column;
    position: sticky;
    top: 0;
    z-index: var(--z-sticky);
  }

  .sidebar-header {
    height: var(--layout-header-height);
    padding: 0 var(--space-6);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-4);
  }

  .sidebar-content {
    flex: 1;
    overflow-y: auto;
    padding: var(--space-6);
    padding-top: var(--space-2);
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
  }

  /* Sidebar Footer */
  .sidebar-footer {
    margin-top: auto;
    padding-top: var(--space-4);
    border-top: 1px solid var(--color-border);
  }

  .llms-link {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    color: var(--color-text-muted);
    text-decoration: none;
    font-size: var(--text-xs);
    border-radius: var(--radius-md);
    transition: all var(--duration-normal) var(--ease-out);
    border: 1px solid transparent;
  }

  .llms-link:hover {
    color: var(--color-text-primary);
    background: var(--color-bg-secondary);
    border-color: var(--color-border);
    text-decoration: none;
  }

  .llms-link svg {
    flex-shrink: 0;
  }

  /* Logo Styles */
  .logo {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    color: var(--color-text-primary);
    font-size: 1.125rem;
    font-weight: var(--font-bold);
    text-decoration: none;
    transition: opacity var(--duration-normal) var(--ease-out);
  }

  .logo:hover {
    text-decoration: none;
    opacity: 0.8;
  }

  .logo-icon {
    font-size: 1.5rem;
  }

  .logo-text {
    font-size: 1.25rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--color-accent-green), var(--color-accent-cyan));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .sidebar-search-trigger {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    width: 100%;
    height: 36px;
    padding: 0 var(--space-3);
    background: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    cursor: pointer;
    transition: all var(--duration-normal) var(--ease-out);
    text-align: left;
    box-shadow: var(--shadow-xs);
  }

  .sidebar-search-trigger:hover {
    border-color: var(--color-border-hover);
    color: var(--color-text-primary);
    box-shadow: var(--shadow-sm);
  }

  .sidebar-search-trigger:focus {
    outline: none;
    border-color: var(--color-border-focus);
    box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
  }

  .sidebar-search-trigger .search-icon {
    flex-shrink: 0;
    width: 14px;
    height: 14px;
    color: var(--color-text-muted);
    transition: color var(--duration-normal) var(--ease-out);
  }

  .sidebar-search-trigger:hover .search-icon {
    color: var(--color-text-primary);
  }

  .sidebar-search-trigger .search-placeholder {
    flex: 1;
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
  }

  .search-kbd {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 20px;
    padding: 0 6px;
    font-size: 10px;
    font-family: var(--font-mono);
    font-weight: 500;
    color: var(--color-text-muted);
    background: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    opacity: 1;
  }

  /* Theme Toggle Styles */
  .theme-toggle {
    width: 64px !important;
    height: 32px !important;
    min-height: 32px !important;
    max-height: 32px !important;
    border-radius: 16px !important;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    padding: 0 !important;
    margin: 0 !important;
    box-sizing: border-box !important;
    transition: all var(--duration-normal) var(--ease-out);
    cursor: pointer;
  }

  .theme-toggle:hover {
    border-color: var(--color-border-hover);
  }

  .sun-icon,
  .moon-icon {
    position: absolute;
    transition: all var(--duration-normal) var(--ease-out);
  }

  :root[data-theme='dark'] .sun-icon {
    opacity: 0;
    transform: rotate(90deg) scale(0.8);
  }

  :root[data-theme='dark'] .moon-icon {
    opacity: 1;
    transform: rotate(0deg) scale(1);
  }

  :root[data-theme='light'] .sun-icon {
    opacity: 1;
    transform: rotate(0deg) scale(1);
  }

  :root[data-theme='light'] .moon-icon {
    opacity: 0;
    transform: rotate(-90deg) scale(0.8);
  }

  /* Responsive (Polar v1.1) */
  @media (max-width: 1024px) {
    .sidebar {
      width: 240px;
    }
  }

  @media (max-width: 768px) {
    .sidebar {
      position: fixed;
      left: -100%;
      top: 0;
      height: 100vh;
      width: var(--layout-sidebar-width);
      z-index: var(--z-modal);
      transition: left var(--duration-slower) var(--ease-out);
      box-shadow: var(--shadow-lg);
    }

    .sidebar.open {
      left: 0;
    }
  }
</style>

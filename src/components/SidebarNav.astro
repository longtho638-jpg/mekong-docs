---
import { getCollection } from 'astro:content';
import { getLangFromUrl, useTranslations, getLocalizedPath } from '../i18n/utils';
import GettingStartedNav from './nav/GettingStartedNav.astro';
import DocsNav from './nav/DocsNav.astro';
import WorkflowsNav from './nav/WorkflowsNav.astro';
import ChangelogNav from './nav/ChangelogNav.astro';
import SupportNav from './nav/SupportNav.astro';
import ToolsNav from './nav/ToolsNav.astro';

interface Props {
  currentPath: string;
}

const { currentPath } = Astro.props;
const currentLocale = getLangFromUrl(Astro.url);

// Detect section from URL
// Detect section from URL
function getSectionFromUrl(path: string): string {
  // Remove language prefix if present (e.g., /vi/docs -> /docs)
  const cleanPath = path.replace(/^\/[a-z]{2}\//, '/');

  if (cleanPath.startsWith('/docs/getting-started')) return 'getting-started';
  if (cleanPath.startsWith('/docs/workflows')) return 'workflows';
  if (cleanPath.startsWith('/docs/tools')) return 'tools';
  if (cleanPath.startsWith('/docs/changelog')) return 'changelog';
  if (cleanPath.startsWith('/docs/support')) return 'support';
  return 'docs';
}

const section = getSectionFromUrl(currentPath);

// Get docs from appropriate collection based on locale
const collectionName = currentLocale === 'vi' ? 'docs-vi' : 'docs';
const allDocs = await getCollection(collectionName, (entry) => entry.data.published);

// Filter by section
const sectionDocs = allDocs.filter(doc => doc.data.section === section);
---

<nav class="sidebar-nav" aria-label="Documentation navigation">
  {section === 'getting-started' && <GettingStartedNav docs={sectionDocs} currentPath={currentPath} />}
  {section === 'docs' && <DocsNav docs={sectionDocs} currentPath={currentPath} />}
  {section === 'workflows' && <WorkflowsNav docs={sectionDocs} currentPath={currentPath} />}
  {section === 'tools' && <ToolsNav docs={sectionDocs} currentPath={currentPath} />}
  {section === 'changelog' && <ChangelogNav docs={sectionDocs} currentPath={currentPath} />}
  {section === 'support' && <SupportNav docs={sectionDocs} currentPath={currentPath} />}
</nav>

<script>
  // State persistence logic (runs client-side)
  const COLLAPSE_KEY = 'agencyos-sidebar-collapse-state';

  function initSidebarState() {
    const saved = sessionStorage.getItem(COLLAPSE_KEY);
    const state = saved ? JSON.parse(saved) : {};

    // Apply saved collapse state
    document.querySelectorAll('[data-collapsible]').forEach(section => {
      const key = section.getAttribute('data-category');
      const isCollapsed = state[key] ?? true; // Default collapsed

      const button = section.querySelector('button');
      const items = section.querySelector('.nav-items');

      if (isCollapsed) {
        section.classList.add('collapsed');
        items?.setAttribute('hidden', '');
      } else {
        section.classList.remove('collapsed');
        items?.removeAttribute('hidden');
      }
    });

    // Add click handlers
    document.querySelectorAll('[data-collapsible] button').forEach(button => {
      button.addEventListener('click', (e) => {
        const section = button.closest('[data-collapsible]');
        const key = section.getAttribute('data-category');
        const items = section.querySelector('.nav-items');

        const isCollapsed = section.classList.toggle('collapsed');

        if (isCollapsed) {
          items?.setAttribute('hidden', '');
        } else {
          items?.removeAttribute('hidden');
        }

        // Save state
        const saved = sessionStorage.getItem(COLLAPSE_KEY);
        const state = saved ? JSON.parse(saved) : {};
        state[key] = isCollapsed;
        sessionStorage.setItem(COLLAPSE_KEY, JSON.stringify(state));
      });
    });
  }

  // Initialize on page load
  document.addEventListener('astro:page-load', initSidebarState);
  document.addEventListener('DOMContentLoaded', initSidebarState);
</script>


<style>
  /* Sidebar Navigation (Polar v1.1) */
  .sidebar-nav {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .nav-section {
    display: flex;
    flex-direction: column;
  }

  /* Section Header (Polar v1.1: 12px uppercase, letter-spacing 0.05em) */
  .nav-section-title {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    background: transparent;
    border: none;
    color: var(--color-text-secondary);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    text-transform: uppercase;
    letter-spacing: var(--tracking-wider);
    cursor: pointer;
    border-radius: var(--radius-md);
    transition: all var(--duration-normal) var(--ease-out);
    margin-bottom: var(--space-1);
  }

  .nav-section-title:hover {
    background-color: var(--color-bg-tertiary);
    color: var(--color-text-primary);
  }

  .chevron {
    transition: transform var(--duration-normal) var(--ease-out);
    color: var(--color-text-muted);
    width: var(--icon-sm);
    height: var(--icon-sm);
  }

  .nav-section.collapsed .chevron {
    transform: rotate(0deg);
  }

  .nav-section:not(.collapsed) .chevron {
    transform: rotate(90deg);
  }

  .folder-icon {
    color: var(--color-accent-blue);
    width: var(--icon-sm);
    height: var(--icon-sm);
  }

  .nav-items {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 0;
    transition: all var(--duration-normal) var(--ease-out);
  }

  .nav-section.collapsed .nav-items {
    display: none;
  }

  /* Navigation Item (Polar v1.1: 14px font, active with 2px blue left border) */
  .nav-item {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    padding-left: calc(var(--space-3) + 32px);
    color: var(--color-text-secondary);
    font-size: var(--text-sm);
    text-decoration: none;
    border-radius: var(--radius-md);
    transition: all var(--duration-normal) var(--ease-out);
    position: relative;
  }

  .nav-item:hover {
    background: var(--color-bg-tertiary);
    color: var(--color-text-primary);
    text-decoration: none;
  }

  /* Active State (Polar v1.1: 2px blue left border) */
  .nav-item.active {
    color: var(--color-text-primary);
    background: var(--color-bg-tertiary);
    font-weight: var(--font-normal);
    border-left: 2px solid var(--color-accent-blue);
    padding-left: calc(var(--space-3) + 30px);
  }

  .file-icon {
    color: var(--color-text-muted);
    width: var(--icon-sm);
    height: var(--icon-sm);
    flex-shrink: 0;
  }

  .nav-item.active .file-icon {
    color: var(--color-accent-blue);
  }

  /* Nested navigation (Polar v1.1) */
  .nav-nested {
    margin-inline-start: var(--space-4);
    padding-inline-start: var(--space-3);
    border-inline-start: 1px solid var(--color-border);
  }

  /* External link indicator (Polar v1.1) */
  .nav-item[data-external]::after {
    content: 'â†—';
    margin-inline-start: auto;
    font-size: var(--text-xs);
    opacity: 0.5;
  }
</style>
